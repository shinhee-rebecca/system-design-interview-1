# 1장. 사용자 수에 따른 규모 확장성

천 리 길도 한 걸음부터, 복잡한 시스템도 마찬가지. 가장 간단한 형태부터 시작해보자

## 단일 서버

서버를 구축하는 모든 요소가 단일 컴퓨터 환경에서 돌아가는 형태

## 데이터베이스

사용자가 늘어남에 따라 웹/모바일 트래픽 처리 서버와 데이터베이스 서버로 분리할 수 있다. (웹 / 데이터베이스 계층 분리 개념)

RDB VS NoSQL — NoSQL 이 유리한 경우

- 아주 낮은 응답 지연시간
- 다루는 데이터가 비정형
- 데이터를 직렬화하거나 역직렬화 할 수 있기만 하면 되는 경우
- 아주 많은 양의 데이터

## 수직적 규모 확장 vs 수평적 규모 확장

비용적 면에서나 안정성, 가용성, 확장성 면에서나 대규모 애플리케이션 지원에 대해서는 수평적 규모 확장이 유리하다

로드밸런서를 이용해 서버를 늘릴 수 있다. 이럴 경우 클라이언트의 요청이 웹서버로 직접 가는 것이 아닌 로드밸런서를 통한다.

- 트래픽 분산
- 추후 서버 확장 시 용이함
- 보안 면에서도 유리 (공용 / 사설 IP 분리)

데이터베이스의 경우도 가용성을 위해 다중화 가능

- Master / Slave 구조 - 원본은 Master, 사본은 Slave
- Master로는 쓰기 연산 / Slave로는 읽기 연산
- <더 알아보기> 다중 마스터와 [원형 다중화](https://blogs.oracle.com/mysql/post/mysql-ndb-cluster-replication-circular-replication-for-activeactive)

## 캐시

도입의 목적은 응답시간 개선

캐시 사용 시 유의할 점

- 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어날 때
- 휘발성 데이터
- 적당한 만료 기간 (짧으면 있으나 마나, 길면 원본과의 차이 증가)
- 일관성 (원본과 캐시 내 데이터가 같은지의 여부)
    - 여러 지역에 걸쳐 시스템을 확장해 나갈 경우 일관성 유지가 아주 어려워진다.
    - 페이스북의 논문 <[Scaling Memcache at Facebook](https://scontent-icn2-1.xx.fbcdn.net/v/t39.8562-6/240873052_277412237132971_6278324660880331641_n.pdf?_nc_cat=101&ccb=1-7&_nc_sid=e280be&_nc_ohc=9IW92Ps51dUQ7kNvwEgNwyc&_nc_oc=AdlDgwEQwi18non-7f6M8ihgdCVfXt-xuQE9VZruPneyRZ9ZGvlHVbxfBJ2iSf9m6VE&_nc_zt=14&_nc_ht=scontent-icn2-1.xx&_nc_gid=Gp42LtJpOw9mHwNBRY-9Ww&oh=00_AfQcbLp8JlW2eDm8x2wdMNADDw6B70ZEEzMnRUPSC-x3jw&oe=687158C2)> 참고
- 장애 대처
    - SPOF(Single Point of Failure) 방지
- 적당한 메모리 크기 (너무 작으면 eviction 의 잦은 발생으로 인한 성능 저하)
    - Overprovision 기법 활용 (스토리지 일부 메모리로..)
- Eviction 정책 - LRU, LFU, FIFO 익숙한 친구들

## 콘텐츠 전송 네트워크 (CDN)

정적 컨텐츠는 CDN 서비스를 이용해 제공하자

<[동적 컨텐츠 캐싱](https://www.cloudflare.com/ko-kr/learning/cdn/caching-static-and-dynamic-content/)도 존재한다.>

- 요청 경로, 질의 문자열, 쿠키, 요청 헤더에 기반해 HTML 페이지를 캐싱. 책에서는 자세히 다루지 않음

CDN 사용시 고려점

- 비용, 만료 시한 설정, 장애 대처 방안
- 콘텐츠 무효화 방법
    - 무효화 API 및 버저닝을 이용해 콘텐츠 관리 가능

## 무상태 웹 계층

수평적 확장 구조에서 상태 아키텍처 사용 시 로드밸런서의 sticky session 기능을 사용해야 하는데 이는 로드밸런서에 부담을 줄 뿐만 아니라 서버 추가 및 제거도 까다롭게 한다. 장애처리 복잡한건 덤

웹 서버 (웹 계층) 을 무상태로 관리하고 공유가 필요한 데이터는 별도의 공유 storage를 이용하자.

- RDB든 NoSQL이든 캐시 시스템이든 그건 상황에 맞춰 잘 고르자

## 데이터 센터

geoDNS routing (지리적 라우팅) - 사용자의 위치에 따라 도메인이 어떤 IP로 변환될지가 결정 됨

데이터 센터를 여러 지역에 분산해 두면 당연히 성능 및 안정성이 좋아지겠죠?

다중 데이터센터 아키텍처 구축의 기술적 난제

- 트래픽 우회: GeoDNS 기술에 달려있다.
- 데이터 동기화: 데이터 센터 별로 별도의 DB를 갖고 있으면 장애시 데이터 유실이 무조건 발생한다.
    - 데이터를 여러 데이터센터에 걸쳐 다중화 하는 것이 보편적 전략
    - <[Netflix가 여러 데이터센터에 걸쳐 데이터를 어떻게 다중화 하는지 알아보자](https://netflixtechblog.com/active-active-for-multi-regional-resiliency-c47719f6685b)>
- 테스트와 배포: 자동화된 테스트와 배포 도구가 다중 데이터 센터 환경에서 어떻게 동작하게 할 것인지

## 메시지 큐

많은 실제 분산 시스템이 컴포넌트 분리와 독립적 확장을 위해 채용하고 있는 핵심적 전략 중 1

오래 걸리는 프로세스를 분리해 비동기적으로 처리할 때에도 사용 가능

## 로그, 메트릭 그리고 자동화

꼭 할 필요는 없지만 있으면 좋다

## 데이터베이스의 규모 확장

수직적 확장은 익히 아는 문제들 (무한한 확장 불가능, SPOF, 비용) 이 항상 존재

샤딩을 이용한 수평적 확장 - 샤딩 키 (파티션 키) 를 잘 정하는 것이 가장 중요하다.

샤딩 시 발생할 수 있는 문제점

- 데이터의 재 샤딩
    - 데이터가 너무 많아져 하나의 샤드로는 감당 힘들 때
    - 샤드 간 데이터 분포가 균등하지 못해 샤드 소진현상이 발생할 때
        - 5장에서 다룰 <<안정 해시>> 기법을 이용해 해결 가능
- celebrity 문제 (hotspot key 문제)
    - 특정 샤드에 질의가 집중되어 DB에 과부하가 걸리는 문제
    - 유명인사 각각에 샤드를 하나씩 할당해야 할 수도 있고 심지어 **잘게 쪼개야 할 수도 있다**
- 조인과 비정규화
    - 샤딩 시에는 조인이 힘들다.
    - DB 비정규화로 조인이 일어나지 않게 하는 해결 기법이 존재한다.

## 백만 사용자, 그리고 그 이상

느꼈듯이 시스템의 규모를 확장하는 것은 지속적이고 반복적인 과정이다.

컴퓨터 구조는 프랙탈 모형이다.

이번 장에서 배운 기법 총 정리

- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고 자동화 도구들을 활용할 것




## 로드밸런서가 고장난다면?
### by jemini
다중화된 서버 환경에서 로드 밸런서에 장애가 발생하면 다음과 같은 문제가 발생할 수 있습니다.

* **서비스 중단**: 로드 밸런서가 모든 트래픽의 진입점 역할을 하므로, 로드 밸런서가 다운되면 모든 사용자 요청이 서버로 전달되지 못하고 서비스가 완전히 중단될 수 있습니다.
* **단일 실패 지점(Single Point of Failure, SPOF)**: 로드 밸런서가 다중화되어 있지 않다면, 로드 밸런서 자체가 시스템의 단일 실패 지점이 되어 전체 시스템의 안정성을 저해합니다.

**따라서 로드 밸런서도 반드시 다중화(이중화 또는 그 이상)해야 합니다.** 로드 밸런서를 다중화하는 일반적인 방법은 다음과 같습니다.

1.  **액티브-스탠바이(Active-Standby) 구성**:
    * 하나의 로드 밸런서가 활성(Active) 상태로 모든 트래픽을 처리하고, 다른 로드 밸런서는 대기(Standby) 상태로 장애 발생 시 활성 로드 밸런서의 역할을 즉시 인계받을 준비를 합니다.
    * 이를 위해 [VRRP(Virtual Router Redundancy Protocol)](https://ko.wikipedia.org/wiki/VRRP)나 [HSRP(Hot Standby Router Protocol)](http://www.ktword.co.kr/test/view/view.php?no=2812)와 같은 프로토콜을 사용하여 가상 IP 주소를 공유하고, 활성 로드 밸런서에 장애가 발생하면 대기 로드 밸런서가 가상 IP를 가져와 트래픽을 처리합니다.

2.  **액티브-액티브(Active-Active) 구성**:
    * 두 개 이상의 로드 밸런서가 동시에 활성 상태로 트래픽을 분산 처리합니다.
    * 이를 통해 처리량을 늘릴 수 있으며, 하나의 로드 밸런서에 장애가 발생해도 나머지 로드 밸런서가 트래픽을 계속 처리하여 서비스 중단을 방지합니다.
    * DNS 라운드 로빈이나 GSLB(Global Server Load Balancing)와 같은 기술을 사용하여 여러 로드 밸런서 간에 트래픽을 분산시킬 수 있습니다.

로드 밸런서의 다중화는 전체 시스템의 고가용성(High Availability)을 보장하고, 단일 실패 지점을 제거하여 안정적인 서비스 운영에 필수적입니다.