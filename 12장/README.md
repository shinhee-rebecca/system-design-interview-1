# 채팅 시스템 설계

## 1단계 문제 이해 및 설계 범위 확정
### 기능
1. 1:1 채팅 및 그룹 채팅 모두 지원
2. 모비일, 웹 모두 지원
3. 단일 계정으로 여러 단말로 동시 접속 지원
4. 푸시 알림
5. 사용자 접속 상태 표시를 지원

## 비기능
1. 텍스트만 주고 받을 수 있음 (메시지 길이는 최대 100,000)
2. 종단간 암호화는 일단 지원하지 않음
3. 채팅 기록은 영원히 보관
4. DAU 5000만
5. 그룹 채팅 최대 100명

### 이든 설계;;
<img width="1302" height="741" alt="image" src="https://github.com/user-attachments/assets/de22beec-f6f5-4319-b701-03dc3300c51a" />

#### 채팅
1. 단말과 웹은 채팅 서버와 웹 소켓 연결을 맺음
2. 무중단 배포를 위해 단말과 채팅 서버에 프록시를 그리고 채팅 서버 사이에 Message Queue를 둠
    - 단말은 배포 전 블루 그룹과 웹 소켓 커넥션을 맺고있고, 배포를 위해 그린 그룹도 배포되어 있는 상태
    - 블루 그룹은 단말과의 웹 소켓 연결을 close 하고, 스트리밍 응답 또는 메시지를 Broker에 Produce
    - 단말은 웹 소켓 라우터를 통해 그린 그룹과 웹 소켓 연결을 맺음
    - 그린 그룹은 Broker로부터 메시지를 Consume 하여 단말에 전달
3. 커넥션을 길게 맺는다는 점에서 웹 소켓을 선호하지는 않지만, 유저 채팅(1:1, 그룹)에 있어서는 여러 이점이 있을 것 같아 웹 소켓 선정
    - ex. 현재 입력중인 유저 표시 등
    - 방 타입에 따라 연결 방식을 다르게 가져갈 수도 있을 듯 (푸시만 받는 방의 경우는 웹 소켓 연결은 필요없음)
4. 알림 서버는 별도 도메인이라고 판단되어 분리하였음.
    - 웹은 별도 제 3자 서비스를 거치지 않고 알림을 받도록 했음.

## 2단계 개략적 설계안 제시 및 동의 구하기
서버가 연결을 만드는 것처럼 보이는 기법들에는 폴링, 롱폴링, 웹 소켓 등이 있다.
### 폴링
클라이언트가 주기적으로 서버에게 새 메시지가 있냐고 물어보는 방법으로,
답해줄 메시지가 없는 경우에는 서버 자원이 불필요하게 낭비된다.

<img width="500" height="500" alt="image" src="https://github.com/user-attachments/assets/a0e3fd5a-aad4-4304-84d3-c4763d354dee" />

가상면접사례로 배우는 대규모 시스템 설계 기초 201p

### 롱폴링
폴링을 비효율성을 개선한 기법이 롱폴링.
<img width="500" height="500" alt="image" src="https://github.com/user-attachments/assets/eace541d-0647-4d56-b865-7653e13dbefd" />

가상면접사례로 배우는 대규모 시스템 설계 기초 202p

클라이언트는 새 메시지가 반환되거나 타임아웃 될 때까지 연결을 유지한다.
클라이언트는 새 메세지를 받으면 기존 연결을 종료하고, 서버에 새로운 요청을 보내어 모든 절차를 다시 시작한다.
메시지를 받지 않는 클라이언트도 주기적으로 다시 서버에 접속해야하므로 여전히 비효율적임. 

### 웹 소켓
서버가 클라이언트에게 비동기 메시지를 보낼 때 가장 널리 사용하는 기술
처음에는 HTTP 연결이지만, 특정 핸드셰이크 절차를 거쳐 웹 소켓 연결로 업그레이드되며, 한 번 맺어진 연결은 양방향이다.
<img width="500" height="500" alt="image" src="https://github.com/user-attachments/assets/f187ddcf-b3a1-4484-be49-58e3ddd5b49d" />

가상면접사례로 배우는 대규모 시스템 설계 기초 203p
## 개략적 설계안
채팅 시스템은 **무상태 서비스**, **상태 유지 서비스**, **제 3자 서비스 연동**로 나눌 수 있다.


### 무상태 서비스
로그인, 회원가입, 사용자 프로파일 표시 등을 처리한다.
