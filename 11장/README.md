# 뉴스 피드 시스템 설계

## 문제 이해 및 설계 범위 확정
- 모바일/웹 둘 다 지원
- 기능
  - 뉴스 피드 페이지에 새로운 스토리를 올릴 수 있어야 한다.
    - 친구들이 올리는 스토리를 볼 수도 있어야 한다.
  - 시간 흐름 역순으로 표시되어야 한다.
  - 최대 5000명의 친구를 갖을 수 있어야 한다.
  - 1000만명 의 유저를 수용할 수 있어야 한다.
  - 스토리에는 이미지나 비디오 등의 미디어 파일이 포함될 수 있어야 한다.
 
## 개략적 설계안 제시 및 동의 구하기
### 뉴스 피드 API
#### 피드 발행 API(POST /v1/me/feed)
- 인자:
  - 바디(body): 포스팅 내용에 해당한다.
  - Autorization 헤더: API 호출을 인증하기 위해 사용한다.

#### 피드 읽기 API(GET v1/me/feed)
- 인자
  - Autorization 헤더: API 호출을 인증하기 위해 사용한다.
 

### 피드 발행
- 사용자: 피드 발행 API(POST /v1/me/feed)를 사용하여 새 포스팅을 올리는 주체이다.
- 로드밸런서: 트래픽을 웹 서버들로 분산한다.
- 웹 서버: HTTP요청을 내부 서비스로 중계하는 역할을 담당한다.
- 포스트 서비스: 새 포스팅을 데이터베이스와 캐시에 저장한다.
- 포스팅 전송 서비스: 새 포스팅을 친구의 뉴스 피드에 푸시한다. 뉴스 피드 데이터는 캐시에 보관하여 빠르게 읽어갈 수 있도록 한다.
- 알림 서비스: 친구들에게 새 포스팅이 올라왔음음을 알리거나, 푸시 알림을 보내는 역할을 한다.

### 뉴스 피드 생성
- 사용자: 피드 읽기 API(GET v1/me/feed)를 이용하여 피드를 읽는 존재이다.
- 로드밸런서: 트래픽을 웹 서버들로 분산한다.
- 트래픽을 뉴스 피드 서비스로 보낸다.
- 뉴스 피드 서비스: 캐시에서 뉴스 피드를 가져오는 서비스다.
- 뉴스 피드 캐시: 뉴스 피드를 렌더링 할 떄 필요한 피드 ID를 보관한다.


## 상세 설계

### 웹 서버
- 웹 서버에서는 클라이언트 통신뿐 아니라, 인증이나 처리율 제한(레이트 리미터) 등의 기능을 수행한다.

### 포스팅 전송(팬아웃) 서비스
- 그 사용자 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.
- 
#### 팬 아웃의 두가지 모델
**쓰기 시점 팬아웃(fanout-on-write, push)**
- 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신한다.
  - 장점
    - 뉴스 피드가 실시간으로 갱신되며, 사용자에게 즉시 전송된다.
    - 새 포스팅이 기록되는 순간에 뉴스 피드가 이미 갱신되므로 뉴스 피드를 읽는 데 드는 시간이 짧아진다.
  - 단점
    - 친구가 많은 사용자의 경우 친구 목록을 가져오고 그 목록에 있는 사용자 모두의 뉴스 피드를 갱신하는데 많은 시간이 소요될 수도 있다.
    - 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 하므로 컴퓨팅 자원이 낭비된다.
   

**읽기 시점에 팬아웃 하는 모델(on-demand, pull)**
- 읽어야 하는 시점에 뉴스 피드를 갱신한다.
  - 장점
    - 비활성화된 사용자, 또는 서비스에 거의 로그인 하지 않는 사용자의 경우에는 이 모델이 유리하다.
    - 데이터를 친구 각각에 푸시하는 작업이 필요 없으므로 핫키 문제도 생기지 않는다.
  - 단점
    - 뉴스 피드를 읽는데 많은 시간이 소요될 수 있다.
   
설계안 에서는 친구 및 팔로어 수에 따라 적을 경우 푸시 모델, 많을 경우 pull모델을 사용하고, 데이터의 경우 안정해시를 이용하여 핫키 문제를 줄일것이다.


#### 팬아웃 서비스의 동작 과정


### 피드 읽기 흐름 상세 설계

### 캐시 구조
