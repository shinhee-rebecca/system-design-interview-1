# 8장 URL 단축기 설계

## URL 단축기가 가져아 하는 기능
- URL 단축: 주어진 긴 URL을 훨씬 짧게 줄인다.
- URL 리디렉션: 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내
- 높은 가요ㅕㅇ성과 규모 확장성, 그리고 장애 감내가 요구됨

### 개략적 추정
- 쓰기 연산: 매일 1억 개의 단축 URL 생성
- 초당 쓰기 연산: 1억/24/3600 = 1160
- 읽기 연산: 읽기 연산 : 쓰기 연산 = 10:1이라 하면 초당 11,600회 발생
- URL 단축 서비스를 10년간 운영한다고 가정하면 1억 * 365 * 10 = 3650억 개의 레코드를 보관해야 한다.
- 축약 전 URL의 평균 길이는 100이라고 하자.
- 따라서 10년 동안 필요한 저장 용량은 3650억 * 10 = 36.5TB이다.

---

## 개략적 설계안 제시 및 동의 구하기

### API 엔드 포인트

#### API URL 단축용 엔드 포인트 ( POST /api/v1/data/shorten )
- 새 단축 URL을 생성
- 인자 \{longUrl: longURLstring\}
- 반환: 단축 URL

#### URL 리디렉션용 엔드포인트 ( GET /api/v1/\{shortUrl\} ) 
- HTTP 요청이 오면 원래 URL로 보내주기 위한 용도의 엔드포인트.
- 반환 : HTTP 리디렉션 목적지가 될 원래 URL

### URL 리디렉션

#### 브라우저에서 short url 입력시 생기는 일


<img width="1113" height="512" alt="image" src="https://github.com/user-attachments/assets/7969bb4d-f227-4f29-a470-e03d439401b1" />

#### 클라이언트와 서버 사이 통신


<img width="750" height="764" alt="image" src="https://github.com/user-attachments/assets/4345a4a3-c9aa-4f4d-9382-2c35b07de49c" />
<details>
  <summary>
    301(Moved Pemanently) vs 302(Found)
  </summary>
  
**301 리디렉션**
- 페이지 랭크 전달: 기존 페이지의 SEO 가치가 새 페이지로 완전히 이전
- 인덱싱: 검색엔진이 새 URL을 색인하고 기존 URL은 제거
- 링크 주스: 외부 링크의 권한이 새 페이지로 전달

**302 리디렉션**
- 페이지 랭크 유지: 원본 URL이 SEO 가치를 계속 보유
- 인덱싱: 검색엔진이 원본 URL을 계속 색인
- 링크 주스: 일시적이므로 권한 전달이 제한적
</details>

---

### URL 단축
<img width="301" height="231" alt="image" src="https://github.com/user-attachments/assets/8c953d5f-162a-43f1-bfa4-8fb28cceadd3" />

#### 요구사항
- 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 한다.
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

---

## 상세 설계

### 데이터 모델
<img width="161" height="141" alt="image" src="https://github.com/user-attachments/assets/a36e66e0-86d3-4e9e-8382-2e8bdb07bed9" />
- id, shortURL, longURL을 갖는 데이터 모델을 갖는다.

### 해시 함수
- 해시 값 길이는 a-z, A-Z, 0-9로 총 62개로 62^n>3650억 인 n의 최솟값을 가져야 한다. 요구사항을 만족시키기 위해서는 7이상의 수를 가져야한다.

#### 해시 후 충돌 해소
- CRC32, MD5, SHA-1같이 잘 알려진 해시 함수를 이용하여 이를 압축한다. 이 때 7자를 만족하기 위해 처음 7개 글자만 이용한다. 아래와 같이 충돌이 될 경우 사전에 정한 문자열을 해시값에 붙여 이를 해결한다. 
<img width="732" height="437" alt="image" src="https://github.com/user-attachments/assets/7b90c030-3795-4bf7-8ec9-a26f7cc17bd7" />

#### base-62변환
- 62진법 변환을 통해 구하는 방식이다.

**두 접근법 비교**
|해시 후 충돌 해소 전략| base-62변환|
|--|--|
|단축 URL의 길이가 고정| 단축 URL의 길이가 가변적, ID 값이 커지면 길이 길어짐|
|유일성이 보장되는 ID 생성기가 필요치 않음| 유일성 보장 ID 생성기 필요|
| 충돌이 가능해서 해소 전략이 필요 | ID와 유일성이 보장된 후에야 적용가능한 전략이라서 충돌이 불가능|
| ID로부터 단축 URL을 계산하는 방식이 아니라, 다음에 쓸 수 있는 URL을 알아낼 수 없음| ID가 1씩 증가하는 값이라고 가정하면 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 알아낼 수 있다.|

---


### URL 단축기 상세 설계
<img width="532" height="407" alt="image" src="https://github.com/user-attachments/assets/cfb5966e-57fd-4cdf-8081-32e0abb1fa90" />

### URL 리디렉션 상세 설계
<img width="1080" height="407" alt="image" src="https://github.com/user-attachments/assets/2a8ce084-6aec-4b88-b433-80172254dbad" />

## 마무리
- 처리율 제한 장치
  - rate limiter를 이용하여 IP 주소를 비롯 한 필터링 규칙등을 통해 여러 요청을 걸러낼 수 있다.
- 웹 서버의 규모 확장
  - 웹 계층은 무상태 계층이므로, 웹 서버를 자유로이 증설하거나 삭제할 수 있다.
- 데이터베이스의 규모 확장
  - 데이터베이스 다중화나 샤딩하여 규모 확장이 가능하다.
- 데이터 분석 솔루션
  - URL 단축기에 데이터 분석 솔루션을 통합해 두면 어떤 링크를 얼마나 많은 사용자가 클릭했는지, 언제 주로 클릭했는지 등 주용한 정보를 알 수 있다.
- 가용성, 데이터 일관성, 안정성
  - 대규모 시스템이 성공적으로 운여오디기 위해서 반드시 지녀야할 속성
 
---

<details>
  <summary>URL 단축기 설계 장 단점</summary>
  **장점**
1. 공간 절약 및 가독성

긴 URL을 짧게 만들어 공간 제약이 있는 플랫폼(트위터, SMS 등)에서 유용
복잡한 매개변수가 포함된 URL을 깔끔하게 표현
인쇄물이나 명함에 기재하기 편리

2. 사용자 경험 개선

기억하기 쉬운 짧은 링크 제공
입력 오류 가능성 감소
모바일에서 터치하기 쉬운 크기

3. 분석 및 추적 기능

클릭 수, 지역별 통계, 시간대별 분석 등 상세한 데이터 제공
A/B 테스트를 위한 다양한 버전 관리
마케팅 캠페인 효과 측정 용이

4. 링크 관리

원본 URL 변경 시 단축 URL은 그대로 유지하면서 리디렉션 가능
만료일 설정으로 임시 링크 관리
브랜딩된 도메인 사용 가능 (예: youtu.be)

5. 보안 기능

악성 링크 필터링 및 경고
클릭 전 미리보기 기능
스팸 방지 기능

**단점**
1. 신뢰성 및 보안 문제

목적지를 미리 알 수 없어 피싱이나 악성 사이트로의 유도 가능
사용자들이 클릭을 꺼려할 수 있음
중간자 공격(man-in-the-middle) 위험

2. 서비스 의존성

단축기 서비스 중단 시 모든 링크가 무효화됨
서버 장애 시 접근 불가
서비스 정책 변경에 따른 영향

3. SEO 및 검색 엔진 최적화

검색 엔진이 단축 URL을 제대로 인덱싱하지 못할 수 있음
링크 주스(link juice) 전달 효과 감소
원본 URL의 키워드 정보 손실

4. 성능 이슈

리디렉션으로 인한 추가 HTTP 요청 발생
로딩 시간 증가 (보통 200-500ms 추가)
네트워크 지연 시 더 큰 영향

5. 투명성 부족

사용자가 실제 목적지를 모르고 클릭
브랜드 신뢰도 저하 가능성
스팸으로 오인될 위험

6. 분석 데이터 제한

단축기 서비스 제공업체에 데이터 의존
상세한 분석을 위해서는 유료 서비스 필요
데이터 소유권 문제
</details>


출처 : 
1) https://bytebytego.com/courses/system-design-interview/design-a-url-shortener

